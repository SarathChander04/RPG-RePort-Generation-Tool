{% extends "base.html" %}
{% block title %}Add Vulnerability to {{ company }}{% endblock %}
{% block content %}

<h2>Add Vulnerability to {{ company }}</h2>

<form method="post" enctype="multipart/form-data">
    <div>
        <label for="vuln_id">Vulnerability:</label>
        <select name="vuln_id" id="vuln_id" required>
            {% for vuln in vulns %}
            <option value="{{ vuln.id }}">
                {{ vuln.name }} [{{ vuln.vapt_type }}] | CVSS: {{ vuln.cvss_score or '-' }} | Severity: {{ vuln.severity }}
            </option>
            {% endfor %}
        </select>
    </div>

    <br>
    <h4>Assign Targets (add more rows as needed)</h4>
    <table id="targets_table">
        <tr>
            <th>Target Name</th>
            <th>Class</th>
            <th>Port (optional)</th>
        </tr>
        <tr>
            <td><input name="target_name" type="text" required></td>
            <td>
                <select name="target_class">
                    <option value="">---</option>
                    {% for cls in classes %}
                    <option value="{{ cls }}">{{ cls }}</option>
                    {% endfor %}
                </select>
            </td>
            <td><input name="target_port" type="text" placeholder="Port"></td>
        </tr>
        <!-- Use Javascript to add more target rows, each must have target_name, target_class, target_port -->
    </table>
    <br>
    <h4>Evidence</h4>
    <div>
        <input type="file" name="evidence_file">
        <br>OR<br>
        <textarea name="evidence_text" rows="3" placeholder="Paste evidence (text/screenshot link)"></textarea>
    </div>
    <br>
    <button type="submit">Add</button>
</form>

<script>
// Minimal JS to add target rows
document.addEventListener('DOMContentLoaded', function() {
    let table = document.getElementById('targets_table');
    let addRowBtn = document.createElement('button');
    addRowBtn.textContent = 'Add Target Row';
    addRowBtn.type = 'button';
    addRowBtn.onclick = function() {
        let row = table.insertRow();
        for (let i=0; i<3; i++) {
            let cell = row.insertCell();
            if (i === 0) cell.innerHTML = '<input name="target_name" type="text" required>';
            if (i === 1) cell.innerHTML = `<select name="target_class">
                <option value="">---</option>
                {% for cls in classes %}
                <option value="{{ cls }}">{{ cls }}</option>
                {% endfor %}
            </select>`;
            if (i === 2) cell.innerHTML = '<input name="target_port" type="text" placeholder="Port">';
        }
    };
    table.parentNode.insertBefore(addRowBtn, table.nextSibling);
});
</script>

{% endblock %}
